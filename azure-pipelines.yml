trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRepo: 'pjasthi/mavenapp'
  dockerUser: 'pjasthi'
  dockerPass: 'Azure@9076'

steps:
# 1. Build the Java Artifact (.war file)
- task: Maven@4
  displayName: 'Maven Package'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    publishJUnitResults: false

# 2. Build the Docker Image 
# Ensure your Dockerfile does: COPY target/*.war /usr/local/tomcat/webapps/
- script: |
    docker build -t $(dockerRepo):latest .
  displayName: 'Build Docker Image'

# 3. Install Trivy
- script: |
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  displayName: 'Install Trivy'

# 4. Security Scan - Output to Console AND Save to File
- script: |
    # This run is for your eyes (shows a nice table in the logs)
    trivy image --severity HIGH,CRITICAL $(dockerRepo):latest
    
    # This run generates a JSON report for documentation
    trivy image --format json --output scanning-report.json $(dockerRepo):latest
  displayName: 'Trivy Scan and Report'
  continueOnError: true # We use this so the pipeline doesn't stop immediately if you want to see the report

- script: |
    docker run --rm -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
      -t http://your-app-url.com \
      -r report.html
  displayName: 'Run OWASP ZAP DAST Scan'

# 5. Upload the Scan Report as an Artifact
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'scanning-report.json'
    ArtifactName: 'SecurityReports'
    publishLocation: 'Container'
  displayName: 'Publish Security Report'

# 6. Push to Docker Hub (Only if you are satisfied with the scan)
# Note: In production, we'd remove 'continueOnError' above to block the push
- script: |
    echo $(dockerPass) | docker login -u $(dockerUser) --password-stdin
    docker push $(dockerRepo):latest
  displayName: 'Push to Docker Hub'