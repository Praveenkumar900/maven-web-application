trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageName: 'my-app'
  registryName: 'youracr.azurecr.io'

steps:
# 1. Build the Docker Image locally on the agent
- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    command: 'build'
    dockerfile: '**/Dockerfile'
    repository: $(imageName)
    tags: 'latest'

# 2. Install Trivy
- script: |
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  displayName: 'Install Trivy'

# 3. Scan the image and FAIL if CRITICAL vulnerabilities are found
- script: |
    trivy image --exit-code 1 --severity CRITICAL $(imageName):latest
  displayName: 'Scan Image for Critical Vulnerabilities'

# 4. Push to Registry (Only runs if the scan above passes)
- task: Docker@2
  displayName: 'Push to ACR'
  inputs:
    containerRegistry: 'YourServiceConnection'
    repository: $(imageName)
    command: 'push'
    tags: 'latest'
